require('dotenv').config(); 
const express = require('express'); 
const cors = require('cors'); 
const app = express(); 
 
// CORS y middleware basico 
app.use(cors({ origin: ['http://localhost:3009', 'http://localhost:3000'], credentials: true })); 
app.use(express.json()); 
 
// Logging 
app.use((req, res, next) => { 
  console.log(`${new Date().toISOString()} ${req.method} ${req.url}`); 
  next(); 
}); 
 
// Cargar rutas de emergencia 
try { 
  const emergencyRoutes = require('./emergency-app-client'); 
  app.use('/api/app', emergencyRoutes); 
  console.log('âœ… Rutas de emergencia cargadas en /api/app'); 
} catch (error) { 
  console.error('âŒ Error cargando rutas de emergencia:', error.message); 
}

// Limpiar cache y cargar rutas ADMIN de emergencia 
try { 
  // Limpiar cache de Node.js
  delete require.cache[require.resolve('./emergency-admin')];
  const adminRoutes = require('./emergency-admin'); 
  app.use('/api/admin', adminRoutes); 
  console.log('âœ… Rutas ADMIN de emergencia cargadas en /api/admin'); 
  console.log('ğŸ”„ Cache limpiado - Nuevas rutas aplicadas'); 
} catch (error) { 
  console.error('âŒ Error cargando rutas ADMIN:', error.message); 
}

// Cargar rutas de VINCULACIÃ“N DNI (nuevas funcionalidades)
try {
  const vinculacionAppRoutes = require('./routes/app-client-vinculacion');
  app.use('/api/app', vinculacionAppRoutes);
  console.log('âœ… Rutas de vinculaciÃ³n APP_CLIENT cargadas');
  
  const vinculacionAdminRoutes = require('./routes/admin-vinculacion');
  app.use('/api/admin', vinculacionAdminRoutes);
  console.log('âœ… Rutas de vinculaciÃ³n ADMIN cargadas');
} catch (error) {
  console.error('âŒ Error cargando rutas de vinculaciÃ³n:', error.message);
  console.log('ğŸ”„ Continuando con rutas de emergencia solamente');
}
 
// 404 handler 
app.use('/api/*', (req, res) => { 
  console.log(`âŒ Endpoint no encontrado: ${req.method} ${req.path}`); 
  res.status(404).json({ success: false, error: 'Endpoint no encontrado', path: req.path }); 
}); 
 
// Root handler 
app.get('*', (req, res) => { 
  res.json({ message: 'Emergency InterTravel Server', status: 'active', endpoints: { health: '/api/app/health', register: '/api/app/auth/register' } }); 
}); 
 
// Start server 
app.listen(3002, () => { 
  console.log('ğŸš¨ EMERGENCY SERVER - Puerto 3002'); 
  console.log('ğŸŒ Health: http://localhost:3002/api/app/health'); 
  console.log('ğŸ“± Register: http://localhost:3002/api/app/auth/register'); 
  console.log('ğŸ‘¥ Admin Users: http://localhost:3002/api/admin/users'); 
  console.log('ğŸŒ Admin Destinations: http://localhost:3002/api/admin/destinations'); 
}); 
